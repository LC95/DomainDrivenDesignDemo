# DDD解码 - 领域服务解释

## SapiensWorks.com作品, LC95自译

[DDD Decoded - Domain Services Explained](https://blog.sapiensworks.com/post/2016/08/16/DDD-Domain-Services-Explained)

当你不知道什么是应用服务时，域服务一开始也有点混乱。许多开发人员试图在他们的聚合中填充大量业务规则, 然而有些可能使用领域服务`Domain Service(DS)`更适合。让我们从一开始....

## 为何我们先需要领域服务

有些业务规则不适合成为聚合的一部分。例如，您希望在借记帐户之前检查帐户余额。或者您希望查看业务规则是否允许某个操作(不要误认为是用户授权)。或者您希望根据领域规则执行简单的计算。**基本上，任何能够推动的业务却不属于任何一个聚合的业务规则都应该是领域服务**。这是用于描述聚合或值对象之外的**业务行为**的DDD术语。

## 怎样识别一个领域服务(DS)

最简单的方法是检查规则是否与维护聚合不变量(包括其值对象)所需的业务约束有关。如果它们不是，它们就是DS，即使它看起来和这个聚合有某种联系。很多时候，您需要生成一个值对象，它将是聚合的一部分。对于示例:您需要一个税务计算器行为，它将生成一个Tax value对象，该对象是发票聚合的一部分。

在其他情况下，您可能需要允许一个操作。还记得转账的例子吗？如果我们有一条规则说你不能借记金额低于余额账户呢？在这个场景中，我们实际上处理的是2个域服务:一个用于计算账户余额值对象(VO)，另一个封装了“金额必须大于余额”规则。

## 贫血领域反模式怎么样？

在一个业务案例中，我们可以使用多个DS，这可能看起来像贫血领域。但它不是，原因是聚合应该尽可能小，不是因为有人这么说，而是因为它们应该只包含该模型的相关行为。不是所有相关的行为。如果某个东西在聚合的“外部”，那么它可能是一个领域服务。

## 实施技巧

DS只是业务行为的一个名称。这并不意味着你必须以这样或那样的方式来实现它。在许多情况下，您可以在一个类中将来自该有界上下文的所有领域服务实现为(静态)函数，而在其他情况下，您可能希望每个DS都有一个类。这要看情况而定。

## 外部服务

假设我们需要计算税收，但领域专家说他们正在使用某个网站来计算(幸运的是，它提供了一个API和一个客户端库)。我们需要这个功能，但是它的实现不是我们领域的一部分。这就是我所说的外部服务。使用它最简单的方法是定义一个抽象(有界上下文的接口部分)，**它的行为就好像它是一个域服务，但是它的实现是基础设施的一部分**，它将作为客户机库的包装器。这就是我们保持解耦的方法。

如果以后计算将在内部执行，只需在BC中实现一个新的类，并重新配置DI容器。小菜一碟。

如果我们需要的服务是我们的应用程序的一部分，但却是另一个BC的一部分呢?对于一块整体，你可以抄近路直接使用它(假设你考虑了后果)。对于分布式应用程序，我建议采用外部服务方法。最后，对于有界上下文来说，它是在其边界之外的东西，在哪里实现实际功能并不重要，只要不在边界之内就行。从BC的角度来看，它是一个外部服务。

## 结论

我们拥有领域服务仅仅是因为我们希望保持概念模型的相关性，因此任何不自然地适合模型的行为都需要以某种方式进行表达。而且，**领域服务不应该关心状态**，它们只表示域行为(它们的实现应该是无状态的)。